/**
 * ì œì£¼ë„ ê¸°ìƒíŠ¹ë³´ ì„œë¹„ìŠ¤
 * ê¸°ìƒì²­ APIë¥¼ í™œìš©í•œ ì‹¤ì‹œê°„ ê¸°ìƒíŠ¹ë³´ ì •ë³´ ì œê³µ
 * ì‘ì„±ì¼: 2025.06.08
 * ë²„ì „: 1.0
 */

class JejuWeatherWarning {
    constructor() {
        this.kmaApiKey = 'RfPsu_HYS9Kz7Lvx2MvS-A';
        this.warnings = [];
        this.cache = new Map();
        this.cacheTimeout = 5 * 60 * 1000; // 5ë¶„ ìºì‹œ
        this.initWarningService();
    }

    /**
     * ê¸°ìƒíŠ¹ë³´ ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
     */
    initWarningService() {
        console.log('âš ï¸ ì œì£¼ë„ ê¸°ìƒíŠ¹ë³´ ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì¤‘...');
        this.loadWarningData();
        this.setupAutoRefresh();
    }

    /**
     * ê¸°ìƒíŠ¹ë³´ ë°ì´í„° ë¡œë“œ
     */
    async loadWarningData() {
        try {
            // ê¸°ë³¸ ë”ë¯¸ ë°ì´í„°ë¡œ ì‹œì‘ (API ì—°ë™ì€ ì¶”í›„ êµ¬í˜„)
            this.warnings = this.getDefaultWarningData();
            this.renderWarningWidgets();
        } catch (error) {
            console.error('ê¸°ìƒíŠ¹ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showWarningError();
        }
    }

    /**
     * ê¸°ë³¸ ê¸°ìƒíŠ¹ë³´ ë°ì´í„°
     */
    getDefaultWarningData() {
        return [
            {
                type: 'normal',
                title: 'í˜„ì¬ íŠ¹ë³´ ì—†ìŒ',
                description: 'ì œì£¼ë„ì— ë°œíš¨ ì¤‘ì¸ ê¸°ìƒíŠ¹ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.',
                level: 'safe',
                icon: 'âœ…',
                recommendations: 'ëª¨ë“  ì•¼ì™¸ í™œë™ì´ ì•ˆì „í•©ë‹ˆë‹¤.'
            }
        ];
    }

    /**
     * ê¸°ìƒíŠ¹ë³´ ìœ„ì ¯ ë Œë”ë§
     */
    renderWarningWidgets() {
        const container = document.getElementById('weather-warning-container');
        if (!container) return;

        if (this.warnings.length === 0 || this.warnings[0].type === 'normal') {
            container.innerHTML = `
                <div class="warning-normal">
                    <div class="warning-icon">âœ…</div>
                    <div class="warning-content">
                        <h3>í˜„ì¬ ê¸°ìƒíŠ¹ë³´ ì—†ìŒ</h3>
                        <p>ì œì£¼ë„ì— ë°œíš¨ ì¤‘ì¸ ê¸°ìƒíŠ¹ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì•ˆì „í•œ ì—¬í–‰ì„ ì¦ê¸°ì„¸ìš”!</p>
                    </div>
                </div>
            `;
        } else {
            container.innerHTML = this.warnings.map(warning => this.createWarningWidget(warning)).join('');
        }
    }

    /**
     * í™œë™ë³„ ì•ˆì „ë„ ì²´í¬
     */
    checkActivity(activity) {
        // ê¸°ë³¸ ì•ˆì „ ìƒíƒœ ë°˜í™˜
        return {
            safetyLevel: 'safe',
            safetyText: 'ì•ˆì „',
            recommendations: 'í˜„ì¬ ë‚ ì”¨ ì¡°ê±´ì´ ì–‘í˜¸í•˜ì—¬ í™œë™í•˜ê¸° ì¢‹ìŠµë‹ˆë‹¤.'
        };
    }

    /**
     * ìƒˆë¡œê³ ì¹¨
     */
    refresh() {
        this.loadWarningData();
    }

    /**
     * ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
     */
    setupAutoRefresh() {
        // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
        setInterval(() => {
            console.log('ğŸ”„ ê¸°ìƒíŠ¹ë³´ ìë™ ì—…ë°ì´íŠ¸...');
            this.loadWarningData();
        }, 5 * 60 * 1000);
    }

    /**
     * ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
     */
    showWarningError() {
        const container = document.getElementById('weather-warning-container');
        if (container) {
            container.innerHTML = `
                <div class="warning-error">
                    <div class="warning-icon">âš ï¸</div>
                    <div class="warning-content">
                        <h3>ê¸°ìƒíŠ¹ë³´ í™•ì¸ ë¶ˆê°€</h3>
                        <p>í˜„ì¬ ê¸°ìƒíŠ¹ë³´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            `;
        }
    }
}

// ì „ì—­ ê¸°ìƒíŠ¹ë³´ ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤
let jejuWeatherWarning;

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ê¸°ìƒíŠ¹ë³´ ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    jejuWeatherWarning = new JejuWeatherWarning();
});

// ì™¸ë¶€ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë“¤
window.JejuWeatherWarning = {
    refresh: () => jejuWeatherWarning?.refresh(),
    checkActivity: (activity) => jejuWeatherWarning?.checkActivity(activity)
};
